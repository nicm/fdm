.\" $Id$
.\"
.\" Copyright (c) 2006 Nicholas Marriott <nicm@users.sourceforge.net>
.\"
.\" Permission to use, copy, modify, and distribute this software for any
.\" purpose with or without fee is hereby granted, provided that the above
.\" copyright notice and this permission notice appear in all copies.
.\"
.\" THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
.\" WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
.\" MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
.\" ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
.\" WHATSOEVER RESULTING FROM LOSS OF MIND, USE, DATA OR PROFITS, WHETHER
.\" IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING
.\" OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
.\"
.Dd August 21, 2006
.Dt FDM.CONF 5
.Os
.Sh NAME
.Nm fdm.conf
.Nd "fdm configuration file"
.Sh DESCRIPTION
This manual page describes the
.Xr fdm 1
configuration file.
It defines
.Em accounts
from which to fetch mail, a number of possible
.Em actions
to take, and
.Em rules
connecting a regexp with an action.
The file is parsed once from top to bottom, so action and account definitions must appear before they are referenced in a rule.
Rules are evaluated from first to last and (unless overridden by the
.Ic continue
keyword) evaluation stops at the first match.
.Pp
The file has the following format:
.Pp
Empty lines and lines beginning with the
.Sq #
character are ignored.
.Pp
Regexps and strings must be enclosed in double quotes.
Special characters in regexps and strings (including passwords) must be escaped.
Note that this may mean double-escaping in regexps.
.Pp
Possible commands are covered in the following sections.
.Sh OPTIONS
Options are configured using the
.Ic set
command.
It may be followed by the following options, one per command:
.Pp
.Bl -tag -width Ds
.It Ic maximum-size Ar size
This is used to set the maximum size of a mail.
Mails larger than this limit are dropped and, if applicable, not deleted from the server.
.Pp
The size may be specified as a plain number in bytes or with a suffix of
.Ql K
for kilobytes,
.Ql M
for megabytes or
.Ql G
for gigabytes.
The default is one gigabyte.
.It Ic delete-oversized
If this option is specified,
.Xr fdm 1
attempts to delete messages which exceed
.Ic maximum-size ,
and continue.
If it is not specified, oversize messages are a fatal error and cause
.Xr fdm 1
to abort.
.It Ic allow-multiple
If this option is specified,
.Xr fdm 1
does not attempt to create a lock file and allows multiple instances to run simultaneously.
.It Ic lock-file Ar path
This sets an alternative lock file.
The default is
.Pa ~/.fdm.lock
for non-root users and
.Pa /var/db/fdm.lock
for root.
.It Ic default-user Ar user
This sets the default user to change to before delivering mail, if
.Xr fdm 1
is running as root and no alternative user is specified as part of the action or rule.
This option may be overridden with the
.Fl u
switch on the command line.
A default user must be given if running as root.
.It Ic lock-types Ar type Ar ...
This specifies the locks to be used for mbox locking.
Possible types are
.Em fcntl ,
.Em flock ,
and
.Em dotlock .
The
.Em flock
and
.Em fcntl
types are mutually exclusive.
The default is
.Em flock .
.It Xo Ic domain Ar domain | Ic domains
.Li {
.Ar domain Ar ...
.Li }
.Xc
This specifies the domains to be used when looking for users with the
.Ic from-headers
keyword.
The default is the computer's hostname.
.It Xo Ic header Ar header | Ic headers
.Li {
.Ar header Ar ...
.Li }
.Xc
This allows the headers to be examined when looking for users to be set.
The default is to look only at the "From" and "Cc" headers.
The headers are case-insensitive.
.It Ic proxy Ar url
This instructs
.Xr fdm 1
to proxy all connections through
.Ar url .
HTTP and SOCKS5 proxies are supported at present (URLs of the form
.Em http://host[:port] or
.Em socks://[user:pass@]host[:port]) .
No authentication is supported for HTTP.
.It Ic unmatched-mail Ar drop | Ar keep
This option controls what
.Xr fdm 1
does with mail that reaches the end of the ruleset (mail that matches no rules or matches only rules with the
.Ic continue
keyword).
.Ar drop
will cause such mail to be discarded, and
.Ar keep
will attempt to leave the mail on the server.
The default is to keep the mail and log a warning that it reached the end of the ruleset.
.It Ic purge-after Ar count
The
.Ic purge-after
option makes
.Xr fdm 1
attempt to purge deleted mail from the server (if supported) after
.Ar count
mails have been retrieved.
This is useful on unreliable connections to limit the potential number of mails refetched if the connetion drops, but note that it can incur a considerable speed penalty.
.It Ic no-received
If this option is present,
.Xr fdm 1
will not insert a
.Sq Received
header into each mail.
.El
.Sh INCLUDING FILES
Further configuration files may be including using the
.Ic include
command:
.Bl -tag -width Ds
.It Ic include Ar path
.El
.Pp
The file to include is searched for first as an absolute path and then relative to the directory containing the main configuration file.
.Sh MACROS
Macros may be defined using the following syntax:
.Bl -tag -width Ds
.It Ar $name Ic = Ar string
.It Ar %name Ic = Ar number
.El
.Pp
Macros are prefixed with $ to indicate a string value and % to indicate a numeric value.
Once defined, a macro may be used in any place a string or number is expected.
Macros may be embedded in strings by surrounding their name (after the $ or %) with {}s, like so:
.Bd -ragged -offset indent
"abc ${mymacro} %{anothermacro} def"
.Ed
.Sh ACCOUNTS
The
.Ic account
command is used to instruct
.Xr fdm 1
to fetch mail from an account.
The syntax is:
.Bl -tag -width Ds
.It Xo Ic account Ar name
.Op Ar users
.Op Ic disabled
.Ar type Op Ar args
.Op Ic keep
.Xc
.El
.Pp
The
.Ar name
argument is a string specifying a name for the account.
The optional
.Ar users
argument has the following form:
.Bl -tag -width Ds
.It Xo Ic user Ar user | Ic users
.Li {
.Ar user ...
.Li } |
.Ic user Ic from-headers
.Xc
.El
.Pp
The first two options specify a user or list of users as which the mail should be delivered when an action is executed.
If
.Ic user Ic from-headers
is specified,
.Xr fdm 1
attempts to find the users from the mail headers, using the values of the
.Ic headers
and
.Ic domains
options.
If no headers are specified, or
.Xr fdm 1
fails to find any valid users in the headers, the default user (set with
.Ic set Ic default-user )
is used.
Users specified as part of the account definition may be overridden by similar arguments to action definitions or on match rules.
If
.Xr fdm 1
is run as non-root, it will still execute any actions once for each user, but will be unable to change to that user so the action will be executed multiple times as the current user.
.Pp
The
.Ic disabled
keyword instructs
.Xr fdm 1
to ignore this account unless it is explicitly enabled with a
.Fl a
option on the command line.
If the
.Ic keep
keyword is specified, all mail collected from this account is kept (not deleted) even if it matches a
.Ic drop
action.
.Pp
Supported account types and arguments are:
.Pp
.Bl -tag -width Ds
.It Ic stdin
This account type reads mail from
.Em stdin ,
if it is connected to a pipe.
This may be used to deliver mail from
.Xr sendmail 8 ,
see
.Xr fdm 1
for details.
.It Xo Ic pop3 Ic server Ar host
.Op Ic port Ar port
.Ic user Ar user Ic pass Ar pass
.Xc
.It Xo Ic pop3s Ic server Ar host
.Op Ic port Ar port
.Ic user Ar user Ic pass Ar pass
.Xc
These statements define a POP3 or POP3S account.
The
.Ar host ,
.Ar user
and
.Ar pass
arguments must be strings.
The port option may be either a string which will be looked up in the
.Xr services 5
database, or a number.
If it is omitted, the default port (143 for POP3, 993 for POP3S) is used.
.It Xo Ic imap Ic server Ar host
.Op Ic port Ar port
.Ic user Ar user Ic pass Ar pass
.Op Ic folder Ar name
.Xc
.It Xo Ic imaps Ic server Ar host
.Op Ic port Ar port
.Ic user Ar user Ic pass Ar pass
.Op Ic folder Ar name
.Xc
These define an IMAP or IMAPS account.
The parameters are as for a POP3 or POP3 account, aside from the additional
.Ic folder
option which allows the folder name to be specified (the default is to fetch from the inbox).
.It Xo Ic imap Ic pipe Ar command
.Op Ic user Ar user Ic pass Ar pass
.Xc
This account type uses the IMAP protocol piped through a
.Ar command ,
such as
.Xr ssh 1 .
If the optional IMAP
.Ar user
and
.Ar pass
are supplied, they will be used if necessary.
If the command produces any output to
.Em stderr ,
it is logged.
.It Ic maildir Ar path
.It Xo Ic maildirs
.Li {
.Ar path ...
.Li }
.Xc
These account types instruct
.Xr fdm 1
to fetch mail from the maildir or maildirs specified.
This allows
.Xr fdm 1
to be used to filter mail, fetching from a maildir and deleting (dropping) unwanted mail, or delivering mail to another maildir or to an mbox.
.It Xo Ic nntp Ic server Ar host
.Op Ic port Ar port
.Ic group Ar group
.Ic cache Ar cache
.Xc
.It Xo Ic nntp Ic server Ar host
.Op Ic port Ar port
.Ic groups
.Li {
.Ar group ...
.Li }
.Ic cache Ar cache
.Xc
An NNTP account.
Articles are fetched from the specified group or groups and delivered.
The index and message-id of the last article fetched in each group is saved in the specified cache file.
When
.Xr fdm 1
is run again, fetching begins at the cached article.
.El
.Sh ACTIONS
The
.Ic action
command is used to define actions.
These may be specified by name in rules (see below) to perform some action on a mail.
The syntax is:
.Bl -tag -width Ds
.It Xo Ic action Ar name Op Ar users
.Ar action
.Xc
.El
.Pp
The
.Ar name
is a string defining a name for the action.
The
.Ar users
argument has the same form as for an account definition.
An action's user setting may be overridden in the matching rule.
.Pp
The possible values for
.Ar action
are listed below.
In actions for which a
.Ar command
or
.Ar path
is specified, the following substitutions are made before it is used:
.Em %a
is replaced by the account name,
.Em %h
by the current user's home directory,
.Em %t
by the name of the current action,
.Em %u
by the current user's login name,
.Em %n
by the UID and
.Em %H
by the current hour (00-23),
.Em %M
minute (00-59),
.Em %S
second (00-59),
.Em %d
day of the month (00-31),
.Em %m
month (01-12),
.Em %y
year,
.Em %W
day of the week (0-6, Sunday is 0),
.Em %Y
day of the year (000-365),
.Em %Q
quarter (1-4) and
.Em %%
with a literal %.
In addition,
.Em %s
is replaced by a string specific to the type of account and
.Em %0
to
.Em %9
with the contents of any subexpressions from the regexp executed as part of the last
.Ic regexp
condition.
When fetching from a maildir, this is the basename of the maildir path.
With pop3 or imap, it is the hostname of the server, as specified in the account definition.
.Bl -tag -width Ds
.It Ic drop
Discard the mail.
.It Ic keep
Keep the mail, do not remove it from the account.
.It Xo Ic maildir Ar path
.Xc
Save the mail to the maildir specified by
.Ar path .
.It Xo Ic mbox Ar path Op Ic compress
.Xc
Append the mail to the mbox at
.Ar path .
If
.Ic compress
is specified,
.Xr fdm 1
will add
.Sq .gz
to
.Ar path
and attempt to write mail using
.Xr gzip 1
compression.
.It Xo Ic pipe Ar command
.Xc
Pipe the entire mail to
.Ar command .
.It Xo Ic write Ar path
.Xc
Write the mail to
.Ar path .
.It Xo Ic append Ar path
.Xc
Append the mail to
.Ar path .
.It Xo Ic smtp Ic server Ar host
.Op Ic port Ar port
.Op Ic to Ar to
.Xc
Connect to an SMTP server and attempt to deliver the mail to it.
If
.Ar to
is specified, it is passed to the server in the RCPT TO command.
If not, the current user and host names are used.
.It Xo Ic rewrite Ar command
.Xc
Pipe the entire mail through
.Ar command
to generate a new mail and use that mail for any following actions or rules.
An example of the
.Ic rewrite
action is:
.Bd -literal -ragged -offset indent
action "cat" pipe "cat"
action "rewrite" rewrite "sed 's/bob/fred/g'"
# this rule will rewrite the message
match all action "rewrite" continue
# this rule will cat the rewritten message
match all action "cat"
.Ed
.El
.Sh RULES
Rules are specified using the
.Ic match
keyword.
It has one of the following basic forms:
.Bl -tag -width Ds
.It Xo Ic match
.Ar condition
.Op Ic and | Ic or Ar condition ...
.Op Ar accounts
.Op Ar users
.Ar actions
.Op Ic continue
.Xc
.It Xo Ic match
.Ar condition
.Op Ic and | Ic or Ar condition ...
.Op Ar accounts
.Ic tag Ar string
.Xc
.El
.Pp
The
.Ar condition
argument may be one of:
.Bl -tag -width Ds
.It Ic all
Matches all mail.
.It Xo Op Ic not
.Ic matched
.Xc
Matches only mail that has matched a previous rule and been passed on with
.Ic continue .
.It Xo Op Ic not
.Ic unmatched
.Xc
The opposite of
.Ic matched :
matches only mails which have matched no previous rules.
.It Xo Op Ic not
.Ic tagged Ar string
.Xc
Matches mails tagged with
.Ar string .
.It Xo Op Ic not
.Op Ic case
.Ar regexp
.Op Ic in Ic headers | Ic in body
.Xc
Specifies a list of regexps against which each mail should be matched.
The regexp matches may be restricted to either the headers or body of the message by specifying either
.Ic in headers
or
.Ic in body .
The
.Ic case
keyword forces the regexp to be matched case-sensitively: the default is case-insensitive matching.
.It Xo Op Ic not
.Ic exec Ar command Op Ic user Ar user
.Ic returns
.Li (
.Ar return code ,
.Ar stdout regexp )
.Xc
.It Xo Op Ic not
.Ic pipe Ar command Op Ic user Ar user
.Ic returns
.Li (
.Ar return code ,
.Ar stdout regexp )
.Xc
These two conditions execute a
.Ar command
and test its return value and output.
The
.Ar return code
argument is the numeric return code expected and
.Ar stdout regexp
is a regexp to be tested against the output of the command to
.Em stdout .
Either of these two arguments may be omitted: if both are specified, both must match for the condition to be true.
The
.Ic pipe
version will pipe the mail to the command's
.Em stdin
when executing it.
If a user is specified,
.Xr fdm 1
will change to that user before executing the command, otherwise the current user (or root if started as root) is used.
.It Xo Op Ic not
.Ic size
.Li <
.Ar number
.Xc
.It Xo Op Ic not
.Ic size
.Li >
.Ar number
.Xc
Compare the mail size with
.Ar number .
.It Xo Op Ic not
.Ic string Ar string Ic to Ar regexp
.Xc
Match
.Ar string
against
.Ar regexp .
If any of %0 to %9 appear in the string, they will be replaced with the contents of any subexpressions from the regexp executed as part of the last
.Ic regexp
condition.
If no
.Ic regexp
condition has yet been seen, or the mail contents has been modified by a
.Ic rewrite
action since the last one, this condition will log a warning and evaluate to false.
.It Xo Op Ic not
.Ic age
.Li <
.Ar time
.Xc
.It Xo Op Ic not
.Ic age
.Li >
.Ar time
.Xc
The
.Ic age
condition examines the mail's date header to determine its age, and matches if the mail is older (<) or newer (>) than the time specified.
The time may be given as a simple number in seconds, or followed by the word
.Em seconds ,
.Em hours ,
.Em minutes ,
.Em days ,
.Em months
or
.Em years
to specify a time in different units.
.It Xo Op Ic not
.Ic attachment Ic count
.Li <
.Ar number
.Xc
.It Xo Op Ic not
.Ic attachment Ic count
.Li >
.Ar number
.Xc
.It Xo Op Ic not
.Ic attachment Ic count
.Li ==
.Ar number
.Xc
.It Xo Op Ic not
.Ic attachment Ic count
.Li !=
.Ar number
.Xc
These conditions match if the mail possesses a number of attachments less than, greater than, equal to or not equal to
.Ar number .
.It Xo Op Ic not
.Ic attachment Ic total-size
.Li <
.Ar size
.Xc
.It Xo Op Ic not
.Ic attachment Ic total-size
.Li >
.Ar size
.Xc
Matches if the total size of all attachments is smaller or larger than
.Ar size .
.It Xo Op Ic not
.Ic attachment Ic any-size
.Li <
.Ar size
.Xc
.It Xo Op Ic not
.Ic attachment Ic any-size
.Li >
.Ar size
.Xc
Compare each individual attachment on a mail to
.Ar size
and match if any of them are smaller or larger.
.It Xo Op Ic not
.Ic attachment Ic any-type
.Ar string
.Xc
.It Xo Op Ic not
.Ic attachment Ic any-name
.Ar string
.Xc
Match true if any of a mail's attachments possesses a MIME type or filename that matches
.Ar string .
.Xr fnmatch 3
wildcards may be used.
.El
.Pp
Aside from the
.Ic all
condition, multiple conditions may be chained together using the
.Ic and
or
.Ic or
keywords.
The conditions are tested from left to right.
The
.Ic not
keyword may be specified to invert the sense of a condition.
.Pp
The first form of the command specifies a number of actions to take when a mail matches the rule.
The second form tags the mail with
.Ar string ,
which may be matched using the
.Ic tagged
condition in later rules.
A mail may be tagged with any number of different strings by different rules.
Rules which apply a tag do not count as a match for the purposes of the
.Ic matched
or
.Ic unmatched
conditions.
.Pp
The optional
.Ar users
argument to the first form has the same syntax as for an
.Ic action
definition.
A rule's user list overrides any users given as part of the actions.
.Pp
Both the
.Ar accounts
and
.Ar actions
parts consist either of a single name or a list of names enclosed in braces:
.Bl -tag -width Ds
.It Xo Ic account Ar name | Ic accounts
.Li {
.Ar name ...
.Li }
.Xc
.It Xo Ic action Ar name | Ic actions
.Li {
.Ar name ...
.Li }
.Xc
.El
.Pp
The
.Ar accounts
list is used to limit rules to matching mail within a set of accounts, and the
.Ar actions
list specifies the actions to perform when the rule matches a mail.
The account names may include shell glob wildcards to match multiple accounts, as with
the
.Fl a
and
.Fl x
command line options.
The actions are performed from left to right in the order they are specified in the rule definition.
.Pp
If the
.Ic continue
keyword is present, evaluation will not stop if this rule is matched.
Instead,
.Xr fdm 1
will continue to match further rules after performing any actions for this rule.
.Sh NESTED RULES
Rules may be nested by specifying further rules in braces:
.Bl -tag -width Ds
.It Xo Ic match
.Ar condition
.Op Ic and | Ic or Ar condition ...
.Li {
.Xc
.It Ic match Ar ...
.It Li }
.El
.Pp
The inner rules will not be evaluated unless the outer one matches.
Rules may be multiply nested.
Note that the outer rule does not count as a match for the purposes of the
.Ic matched
and
.Ic unmatched
conditions.
.Sh FILES
.Bl -tag -width "/var/db/fdm.lockXXX" -compact
.It Pa ~/.fdm.conf
default
.Nm
configuration file
.It Pa /etc/fdm.conf
default system-wide configuration file
.It Pa ~/.fdm.lock
default lock file
.It Pa /var/db/fdm.lock
lock file for root user
.El
.Sh SEE ALSO
.Xr fdm 1 ,
.Xr re_format 7
.Sh AUTHORS
.An Nicholas Marriott Aq nicm@users.sourceforge.net

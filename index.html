<!-- $Id$ -->
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>fdm</title>
</head>
<body>
<p>The project page is <a href="http://sf.net/projects/fdm">here.</a></p>
<hr>
<p>Please note: this manual is for the CVS version of fdm (what will become 0.7). It is here because, well, it is better than what was here before. Most of it applies equally to 0.6, but there are a few differences, most notably that 0.6 does not support using single-quotes (') to avoid escaping in strings.</p>
<hr>
<pre>
<h1>fdm </h1>
1	Introduction
2	Installation
3	Quick start
4	The configuration file
4.1	Macros
4.2	Including other files
5	Invoking fdm
5.1	Command line arguments
5.2	Running from cron
5.3	The lock file
5.4	Testing and debugging
6	Fetching mail
6.1	POP3 and POP3S
6.2	IMAP and IMAPS
6.3	Stdin and local mail
6.4 	From maildirs
7	Defining actions
7.1	Drop and keep
7.2	Maildirs
7.3	Mboxes
7.4	SMTP
7.5	Write, pipe and append
7.6 	Rewriting mail
8	Filtering mail
8.1	Nesting rules
8.2	The all condition
8.3	Matched and unmatched
8.4	Matching a regexp
8.5	Matching by age or size
8.6	Using a shell command
8.7	Tagging
9	Setting options
10	Archiving and searching mail
11	Using fdm behind a proxy
12	Bug reports and queries
13	Frequently asked questions

<h1>Introduction </h1>
fdm is a program to fetch mail and deliver it in various ways depending on as
user-supplied ruleset. Mail may be fetched from stdin, IMAP or POP3 servers, or
from local maildirs, and filtered based on whether it matches a regexp, its
size or age, or the output of a shell command. It can be rewritten by an
external process, dropped, left on the server or delivered into maildirs,
mboxes, to a file or pipe, or any combination.

fdm is designed to be lightweight but powerful, with a compact but clear
configuration syntax. It is primarily designed for single-user uses but may
also be configured to deliver mail in a multi-user setup. In this case, it uses
privilege separation to minimise the amount of code running as the root user.

<h1>Installation </h1>
Installing fdm is simple. Download the source tarball, and run:

$ tar -zxvf fdm-?.?.tar.gz
$ cd fdm-?.?.tar.gz
$ make

Then run 'make install' to install to the default locations under /usr/local.
The PREFIX environment variable may be set to specify an alternative
installation location:

    $ export PREFIX=/opt		# defaults to /usr/local
    $ sudo make install

<h1>Quick start </h1>
A simple ~/.fdm.conf file for a single user fetching from POP3, POP3S and IMAP
accounts and delivering to one maildir may look similar to:

 	# Set the maximum size of mail.
	set maximum-size 128M

	# An action to save to the maildir ~/mail/inbox.
	action "inbox" maildir "%h/mail/inbox"

	# An action to drop unwanted mail.
	action "drop" drop
	
	# Accounts: POP3, POP3S and IMAP. Note the double escaping of the '\'
	# character in the password. If the port is omitted, the default
	# ("pop3", "pop3s", "imap" or "imaps" in the services(5) db) is used.
	account "pop3" pop3 server "my.pop3.server"
		user "my-username" pass "my-password-with-a-\\-in-it"
	account "pop3s" pop3 server "pop.googlemail.com" port 995
		user "my-account@gmail.com" pass "my-password"
	# If the 'folder "my-folder"' argument is omitted, fdm will fetch mail
	# from the inbox.
	account "imap" imap server "my.imap.server"
		user "my-username" pass "my-password" folder "my-folder"
	
	# Discard mail from Bob Idiot. Note that the regexp is an extended 
	# regexp, and case-insensitive by default.
	match "From:.*bob@idiot\\.net" action "drop"

	# Match all other mail and deliver using the 'inbox' action.
	match all action "inbox"

A simple initial configuration file without filtering, perhaps to replace
fetchmail or getmail delivering to maildrop, may look similar to:

 	# Set the maximum size of mail.
	set maximum-size 128M

	# Action to pipe directly to maildrop.
	action "maildrop" pipe "/usr/local/bin/maildrop"

	# Account definitions.
	account ....

	# Send all mail to maildrop.
	match all action "maildrop"

To run fdm every half hour from cron, add something like this:

*/30    *       *       *       *       /usr/local/bin/fdm -l fetch

See the fdm.conf(5) man page or the rest of this manual for more detail of the
configuration file format.

<h1>The configuration file </h1>
fdm is controlled by its configuration file. It first searches for a .fdm.conf
file in the invoking user's home directory. If that fails, fdm attempts to use
/etc/fdm.conf. The configuration file may also be specified using the '-f'
command line option, see the section on that subject below.

This section gives an overview of the configuration file syntax. Further
details of syntax, and specific keywords, are covered in later sections.

The configuration file has the following general rules:

- Keywords are specified as unadorned lowercase words: match, action, all.
- Strings are enclosed in double quotes (") or single quotes ('). In double
  quoted strings, double quotes may be included by escaping them using the
  backslash character (\). Backslashes must also be escaped ("\\") - this
  applies to all such strings, including regexps and passwords. The special
  sequence '\t' is replaced by a tab character. In single quoted strings no
  escaping is necessary, but it is not possible to include a literal ' or a
  tab character.
- Comments are prefixed by the hash character (#) and continue to the end of
  the line.
- Whitespace is largely ignored. Lines may generally be split, concatenated
  or indented as preferred.
- Lists are usually specified as 'singular item' or 'plural { item item }', for
  example: 'user "nicholas"', 'users { "nicholas" "bob" }'.
- Regexps are specified as normal strings without additional adornment other
  than the "s (not wrapped in /s). All regexps are extended regexps and 
  case insensitive by default.

Definition/option lines generally follow the following basic form:

	&lt;keyword&gt; &lt;name or command&gt; &lt;parameters&gt;

Example lines that may appear in a configuration file are:
	
	# This is a comment.

	set lock-types flock

	account "stdin" disabled stdin

	action "strip-full-disclosure"
		rewrite "sed 's/^\\(Subject:.*\\)\\[Full-disclosure\\] /\\1/'"

	match "^X-Mailing-List:.*linux-kernel@vger.kernel.org" in headers
		or "^(To:|Cc:):.*@vger.kernel.org" in headers
		action "linux-kernel"

<h2>Including other files </h2>
The fdm configuration may be split into several files. Additional files may
be referenced using the 'include' keyword:

	include "my-include-file.conf"

	include	"/etc/fdm.d/shared-conf-1.conf"

<h2>Macros </h2>
Macros may be defined and used in the configuration file. fdm makes a
distinction between macros which may hold a number (numeric macros) and
those that hold a string (string macros). Numeric macros are prefixed with
the percentage sign (%) and string by the dollar sign ($). Macros are 
defined using the equals operator (=):

	%nummacro = 123

	$strmacro = "a string"

Macros may then be referenced in either a standalone fashion anywhere a string
or number is expected, depending on the type of macro:

	$myfile = "a-file"
	include $myfile

	%theage = 12
	match age &lt; %theage action "old-mail"

Or embedded in a string by enclosing the macro name in {}s:

	$myfile2 = "a-file2"
	include "/etc/${myfile}"

	%anum = 57
	include "/etc/file-number-%{anum}"

<h1>Invoking fdm </h1>
fdm may be invoked manually from the command line or regularly using a program
such as cron(8).

<h2>Command line arguments </h2>
The fdm binary has the following synopsis:

fdm [-klmnv] [-f conffile] [-u user] [-a account] [-x account] [fetch | poll]

The meaning of the flags are covered in the fdm(1) man page, but a brief
description is given below. The flags are also mentioned at relevant points 
in the rest of this document.

Flag	Meaning
-k 	Keep all mail (do not delete it from the server). This is useful for
	testing delivery rules without risking mailing ending up permanently
	in the wrong place.
-l	Log to syslog(3) using the 'mail' facility rather than outputting to
	stderr.
-m	Ignore the lock file.
-n	Run a syntax check on the configuration file and exit without fetching
	any mail.
-v	Print verbose debugging output. This option may be specified multiple
	times for increasing levels of verbosity. Useful levels are -vv to
	display the result of parsing the configuration file, and -vvvv to copy
	all traffic to and from POP3 or IMAP servers to stdout (note that -l
	disables this behaviour).
-f conffile
	Specify the path of the configuration file.
-u user	
	Use 'user' as the default user for delivering mail when started as
	root.
-a account
	Process only accounts with a name matching the given pattern. Note that
	fnmatch(3) wildcards may be used to match multiple accounts with one
	option, and that the option may be specified multiple times.
-x account
	Process all accounts except those that match the given pattern. Again,
	fnmatch(3) wildcards may be used, and the -x option may be specified
	multiple times.

If -n is not specified, the flags must be followed by one of the keywords
'fetch' or 'poll'. The 'fetch' keyword will fetch and deliver mail, the 'poll'
keyword print an indication of how many mails are present in each account.
'fetch' or 'poll' may be abbreviated.

Examples:

	$ fdm -v poll

	$ fdm -vvnf /etc/my-fdm.conf

	$ fdm -lm -a pop3\* fetch

	$ fdm -x stdinacct fetch
	
	# fdm -u nicholas -vv f

<h2>Running from cron </h2>
To fetch mail regularly, fdm must be run from cron. This line in a crontab(5)
will run fdm every 30 minutes:

*/30   *      *      *      *      /usr/local/bin/fdm -l fetch

The '-l' option sends fdm's output to syslog(3) rather than having cron mail
it. To keep a closer eye, adding '-v' options and removing '-l' will have
debugging output mailed by cron, or, using a line such as:

*/30   *      *      *      *      fdm -vvvv fetch &gt;&gt;/home/user/.fdm.log 2&gt;&1

Will append extremely verbose fdm output to the ~/.fdm.log file. Note that this
log file can become pretty large, so another cronjob may be required to remove
it occasionally!

<h2>The lock file </h2>
fdm makes use of a lock file to prevent two instances running simultaneously.
By default, this lock file is .fdm.lock in the home directory of the user who
runs fdm, or /var/db/fdm.lock for root. This default may be overridden in
the configuration file with the 'set lock-file' command:

	set lock-file "/path/to/my/lock-file"

Or disabled altogether by being set to the empty string:

	set lock-file ""

The '-m' command line option may be used to force fdm to ignore the lock file
and run regardless of its existence and without attempting to create it.

<h2>Testing and debugging </h2>
fdm has some features to assist with testing and debugging a ruleset:

The '-n' command line option. This is particularly useful in conjunction with
'-vv', for example:

	$ cat test.conf
	account "pop3" pop3 server "s" user "u" pass "p"
	action "rw" rewrite "sed 's/\\(Subject:.*\\)\\[Crap\\]/\1/'"
	action "mbox" mbox "%h/INBOX"
	match all actions { "rw" "mbox" }
	$ fdm -vvnf test.conf
	version is: fdm 0.6 (20061204-1433)
	starting at: Tue Dec  5 15:45:41 2006
	user is: nicholas, home is: /home2/nicholas
	loading configuration from test.conf
	added account: name=pop3 fetch=pop3 server "s" port pop3 user "u"
	added action: name=rw deliver=rewrite "sed 's/\(Subject:.*\)\[XYZ\]/1/'"
	added action: name=mbox deliver=mbox "%h/INBOX"
	finished file test.conf
	added rule: actions="rw" "mbox" matches=all
	configuration loaded
	locking using: flock 
	headers are: "to" "cc"
	domains are: "yelena"
	using tmp directory: /tmp

Looking at the output, the parsed strings used by fdm can be seen, and it is
possible to spot that an escape character has been missed in the command.

The 'k' command line option (and the 'keep' keywords on actions and accounts,
covered later) prevent fdm from deleting any mail after delivery. This may be
used to perform any number of test deliveries without risk of losing mail.

<h1>Fetching mail </h1>
fdm fetches mail from a set of 'accounts', defined using the 'account'
keyword. Each account has a name, a type, a number of account specific
parameters and a couple of optional flags. The general form is:

	account &lt;name&gt; [disabled] &lt;type&gt; [&lt;parameters&gt;] [keep]

The &lt;name&gt; item is a string by which the account is referred in filtering
rules, log output and for the '-a' and '-x' command line options.

If the optional 'disabled' keyword is present, fdm ignores the account unless
it is specified on the command line using the '-a' flag.

The optional 'keep' keyword instructs fdm to keep all mail from this account
(not delete it from the server) regardless of the result of the filtering
rules.

The &lt;type&gt; item may be one of: 'pop3', 'pop3s', 'imap', 'imaps', 'stdin',
'maildir' or 'maildirs'.

<h2>POP3 and POP3S </h2>
Mail may be fetched from a POP3 account. A POP3 account is defined by
specifying the following parameters: the server host and optionally port, and
the user name and password. If the port is not specified, the default port
('pop3' in the services(5) database) is used. Examples of such an account
definition are:

	account "pop3acct" pop3 server "pop.isp.com" user "bob" pass "pass"
	
	account "gmx" pop3 server "pop.gmx.net" port 110 user "jim" pass "pass"

	account "acct" pop3 server "10.0.0.1" port "pop3"
		user "nicholas" pass "my-password" keep

	account "lycos" disabled pop3 server $localserver port 10110
		user "bob@lycos.co.uk" pass "password"

Note that the server string is enclosed in double quotes even if it is an IP,
and don't forget to escape any " and \ characters in passwords!

POP3S is specified in exactly the same way, except using the 'pop3s' keyword
for the type, and the default port is 'pop3s' rather than 'pop3':

	account "pop3sacct" pop3s server "pop.isp.com" user "bob" pass "pass"

<h2>IMAP and IMAPS </h2>
IMAP and IMAPS accounts are defined using exactly the same syntax as for POP3
and POP3S, aside from using the 'imap' or 'imaps' keywords and that the default
port is 'imap' or 'imaps'. There is also an additional, optional 'folder'
option to specify the folder from which mail should be fetched. If omitted,
the folder defaults to the inbox.

Note that with IMAP and IMAPS, mail is still removed from the server unless the
'keep' option is given, or the '-k' command line option used.

Examples of IMAP and IMAPS accounts include:

	account "imapacct" imap server "imap.server.ca" user "bob" pass "pass"

	account "oldimap" disabled imaps server "192.168.0.1" port 10993
		user "nicholas" pass "pass" folder "Saved"

	account "workspam" disabled imap server "my-work.ath.cx"
		user "Nicholas" pass "pass" folder "Junk"

<h2>Stdin and local mail </h2>
fdm may be configured to fetch mail from stdin, by specifying an account of
type 'stdin', for example:

	account "stdin" disabled stdin

This is most useful to have fdm behave as a mail delivery agent. To configure
it for single-user use with sendmail, the simplest method it to add:

	"|/usr/local/bin/fdm -m -a stdin fetch"

To the user's ~/.forward file (including the double quotes). Note the use of
'-m' to prevent stdin delivery from interfering with any normal cronjob, and
'-a' to specify that only the disabled "stdin" account should be fetched.

<h2>From maildirs </h2>
Fetching from maildirs allows fdm to be used to filter mail on the local
machine. This is covered more detail in the later section on archiving and
searching.

Maildir accounts are specified as follows:

	account "mymaildir" maildir "/path/to/dir"

	account "mymaildirs" maildirs { "/path/to/dir1" "/path/to/dir2" }

<h1>Defining actions </h1>
An action is a particular command to execute on a mail when it matches a 
filtering rule (see the next section on filtering mail). Actions are named,
similar to accounts, and have a similar form:

	action &lt;name&gt; [&lt;users&gt;] &lt;type&gt; &lt;parameters&gt;

The &lt;users&gt; item may be either:

- the keyword 'user' followed by a single username string or uid, such as:

	user "nicholas"

	user 1000	

- the keyword 'users' followed by a list of users in {}s, for example:

	users { 1001 "nicholas" }

- the keyword 'from-headers', that will attempt to ascertain a set of users
  from the mail headers (see the 'domains' and 'headers' options in the
  section on setting options).

If users are specified, the action will be run once for each user, with fdm
changing to that user before executing the action. Note that fdm will execute
the action once for each user even when not started as root, but will not be
able to change to the user. The user keyword is primarily of use in multiuser
configurations.

If running as root and no user is specified on either the action or on the 
filtering rule (see the section on filtering below), the default user is
used, see the '-u' command line option and the 'default-user' option in the
setting options section

<h2>Drop and keep actions </h2>
The simplest actions are the 'drop' and 'keep' actions. They have no parameters
and are specified like this:

	action "mydropaction" drop

	action "mykeepaction" keep
	
The 'drop' action arranges for mail to be dropped when rule evaluation is
complete. Note that using 'drop' does not stop further evaluation if the
filtering rule contains a 'continue' keyword, and it may be overridden by a
'keep' option on the account or by the '-k' flag on the command line.

The 'keep' action is similar to 'drop', but it arranges for the mail to be
kept once rule evaluation is complete, rather than dropped.

<h2>Maildirs </h2>
Mails may be saved to a maildir through a 'maildir' action, defined like so:

	action "mymaildiraction" maildir "/path/to/maildir"

In the path, the following special tokens are replaced:

Token	Replaced with
%a	The name of the account this mail was fetched from.
%s	A string specific to the type of account the mail was fetched from.
	For maildirs, it is the basename of the maildir, for IMAP and POP3 it
	is the server hostname as specified in the account definition.
%h	The delivery user's home directory.
%n	The delivery user's uid.
%t	The name of the action.
%u	The delivery user's username.
%H	The current hour (00-23).
%M	The current minute (00-59).
%S	The current second (00-59).
%d	The current day of the month (00-31).
%m	The current month (01-12).
%y	The current year.
%W	The current day of the week (0-6, Sunday is 0).
%Y	The current day of the year (000-365).
%Q	The current quarter (1-4).

If the maildir does not exist, it is created.

<h2>Mboxes </h2>
An action to deliver to an mbox is defined in the same way as for a maildir:

	action "mymboxaction" mbox "/path/to/mbox"

The same % tokens are replaced in the path. If the mbox does not exist, it
is created.

<h2>SMTP </h2>
An action may be defined to pass mail on over SMTP. The server host must be
specified and optionally the port and a string to pass to the server with
the RCPT TO command. If the port is not specified it defaults to "smtp".
Examples include:

	action "mysmtpaction" smtp server "smtp.server"

	action "mysmtpaction" smtp server "smtp.server" port 587

	action "mysmtpaction" smtp server "smtp.server" port "submission"

	action "mysmtpaction" smtp server "smtp.server" to "me@somewhere"

<h2>Write, pipe and append </h2>
Actions may be defined to write or append a mail to a file, or to pipe it to
a shell command. The append action appends to and write overwrites the file.
% tokens are replaced in the file or command as for maildir and mbox actions.
Examples are:

	action "mywriteaction" write "/tmp/file"

	action "myappendaction" append "/tmp/file"

	action "mypipeaction" pipe "cat &gt; /dev/null"

<h2>Rewriting mail </h2>
Mail may be altered by passing it to a rewrite action. This is similar to
the pipe action, but the output of the shell command to stdout is reread by fdm
and saved as a new mail. This is useful for such things as passing mail
through a spam filter or removing or altering headers with sed. Note that
rewrite only makes sense on filtering rules where the continue keyword is
specified, or where multiple actions are used (see the next section for details
of this). Possible rewrite action definitions are:

	action "myspamaction" rewrite "bmf -p"

	action "mysedaction" rewrite "sed 's/x/y/'"

<h1>Filtering mail </h1>
Mail is filtered by defining a set of filtering rules. These rules tie together
mail fetched from an account and passed to one or more actions. Rules are
evaluated from top-to-bottom of the file, and evaluation stops at the first
matching rule (unless the continue keyword is specified).

The general form of a filtering rule is:

	match &lt;conditions&gt; [&lt;accounts&gt;] [&lt;users&gt;] &lt;actions&gt; [continue]

The optional &lt;users&gt; item is specified as for an action definition. If users
are specified on a filtering (match) rule, they override any specified on the
action.

The &lt;conditions&gt; item is set of conditions against which the match may be
specified, each condition returns true or false. Conditions are described in
the next few sections. Aside from the 'all' condition, which is a special case,
conditions may be chained as an expression using 'and' and 'or', in which case
they are evaluated from left to right at the same precedence, or prepended with
'not' to invert their outcome.

The optional &lt;accounts&gt; item is a list of accounts for which the rule provided
applies. It is specified as either a single account ('account "name"') or a list
of accounts ('accounts { "name1" "name2" }').

The &lt;actions&gt; item is a list of actions to execute when this rule matches.
It is in the same list format: 'action "name"' or "actions { "name1" "name2" }'.

If a rule with the 'continue' keyword matches, evaluation does not stop after
the actions are executed, instead subsequent rules are matched.

<h2>Nesting rules </h2>
Filtering rules may be nested by using the special form:

	match &lt;conditions&gt; [&lt;accounts&gt;] {
		match ...
	}

If the conditions on the outer rule match, the inner rules are evaluated. If 
none of the inner rules match (or they all specify the 'continue' keyword)
evaluation continues outside to rules following the nested rule, otherwise it
stops.

<h2>The all condition </h2>
The all condition matches all mail. It may not be used as part of an expression
with the 'and', 'or' and 'not' operators.

Examples include:

	match all action "default"

	match all rewrite "rewaction" continue

<h2>Matched and unmatched </h2>
The matched and unmatched conditions are used to match mail that has matched
or has not matched previous rules and been passed on with the 'continue'
keyword. For example,

	match all action "act1" continue
	# This rule will match only mails that also matched the first.
	match matched action "act2"
	# This rule will match only mails that matched neither of the first two.
	match unmatched action "act3"

<h2>Matching a regexp </h2>
Matching against a regexp is the most common form of condition. It takes the
following syntax:

	[case] &lt;regexp&gt; [in headers|in body]

The 'case' keyword instructs fdm to match the regexp case sensitively rather
than the default of case insensitivity. The 'in headers' or 'in body' keywords
in struct fdm to search only the headers or body of each mail, the default is
to match the regexp against the entire mail. The regexp itself is an extended
regexp specified as a simple string, but care must be taken to escape \s and 
"s properly.

Examples include:

	match "^From:.*bob@bobland\\.bob" in headers account "pop3" action "act"
	
	match ".*YAHOO.*BOOTER.*" in body action "junk"

<h2>Matching by age or size </h2>
Mail may be matched based on its age, or its size. An age condition is
specified as follows:

	age [&lt;|&gt;] &lt;age&gt; [hours|minutes|seconds|days|months|years]

If '&lt;' is used, mail is matched if it is older than the specified age. If '&gt;',
if it is younger. The &lt;age&gt; item may be a simple number of seconds, or suffixed
with a unit. Examples are:

	match age &lt; 3 months actions { "act1" "act2" }

	match age &gt; 100 hours action "tooold"

The size condition is similar:

	size [&lt;|&gt;] &lt;size&gt;

Where &lt;size&gt; is a simple number in bytes, or suffixed directly (no space) with
'K', 'M' or 'G' to specify a size in kilobytes, megabytes or gigabytes, such
as:

	match size &lt; 1K action "small"

	match size &gt; 2G action "whoa"

<h2>Using a shell command </h2>
Mail may be matched using the result of a shell command. This condition follows
the form:

	[exec|pipe] &lt;command&gt; returns (&lt;return code&gt;, &lt;stdout regexp&gt;)

If 'exec' is used, the command is executed. If 'pipe', the mail is piped to the
command's stdin. The &lt;command&gt; is a simple string. % tokens are replaced as
normal, with the exception of %t.

Any of the &lt;return code&gt; or &lt;stdout regexp&gt; or both may be specified. The
&lt;return code&gt; is a simple number which is compared against the return code from
the command, the &lt;stdout regexp&gt; is a regexp that is matched case insensitively
against each line output by the command on stdout. Any output on stderr is
logged by fdm, so 2&gt;&1 must be included in the command in order to apply the
regexp to it too.

Examples:

	match exec "true" (0, ) action "act"

	match not pipe "grep Bob" (1, ) action "act"

	match pipe "myprogram" (, "failed") actions { "act1" "act2" }

	match exec "blah" (12, "^Out") action "meep"

<h2>Tagging </h2>
Mails may be assigned one of more tags using a special form of filtering
rule with the following syntax:

	match &lt;conditions&gt; [&lt;accounts&gt;] tag &lt;tag&gt;

The string &lt;tag&gt; is attached to the mail. A mail may have multiple tags.

The tag may be tested for using the 'tag' condition:

	match tag "mytag" action "a"

	match tag "ohno" and size &gt;1K action "drop"

<h1>Setting options </h1>
fdm has a number of options that control its behaviour. These are defined
using the set command:

	set &lt;option&gt; [&lt;value&gt;]

The possible options are:

- maximum-size &lt;size&gt;

This specifies the maximum size of mail that fdm will accept. fdm uses /tmp
(by default) to save mails, it is recommended that this be less than the
size of the /tmp partition (less than half the size if using rewrite). If
mail over this size is encountered, fdm will abort with an error, without
deleting the mail from the server (unless 'delete-oversized' is set).

- delete-oversized

If this option is set, fdm will delete oversized mail from the server rather
than leaving it for the user to sort out.

- allow-multiple

This option makes fdm ignore the lock file, similar to the '-m' command line
option.

- lock-file &lt;path&gt;

This option specifies string which should be the path of the file to use as the
lock file. For example:

	set lock-file "/tmp/my-lock-file"

- default-user &lt;user&gt;

This specifies the default user to use if run as root and no users are specified
on the action or filtering rule. This option may be overriden with the '-u'
flag on the command line.

- lock-types [fcntl] [flock] [dotlock]

These specify the type of locking to use when writing to mboxes. fcntl and
flock locking is mutually exclusive, but dotlock may be used with either.
Some NFS servers do not support fcntl. The default is flock only. Example:

	set lock-types fcntl dotlock

- [domain|domains] &lt;domains&gt;

This specifies a domain or list of domains to use when searching for users in
mail headers with the 'from-headers' keyword. Examples include:

	set domain "xyz.ath.cx"

	set domains { "abc.ca" "def.co.uk" }

The default is the hostname of the local machine.

- [header|headers] &lt;headers&gt;

This specifies a header or list of headers to search with the 'from-headers'
keyword, such as:

	set header { "to" "cc" }
	
	set headers "x-envelope-to"

The default is "to" "cc".

- proxy &lt;url&gt;

This specifies a URL to proxy outgoing connections through. See the section
on proxying below.

- unmatched-mail [drop|keep]

This option controls how fdm should deal with mail that reaches the end of
the ruleset (doesn't match any rules, or only rules with the 'continue'
keyword). If 'drop' is specified, such mail is dropped. If 'keep', it is
kept. The default is to keep the mail, and issue a warning. 

In addition to these options, some environment variables may be used to control
fdm. If TMPDIR is present, its value will be used instead of /tmp for saving
temporary files.

<h1>Archiving and searching mail </h1>
As fdm can fetch from maildirs, it can be used to filter mail from one maildir
into another, for example to archive older mail (with drop) or to search for
mail matching a particular pattern (with keep). The 'age' condition, and the
%s and time/date % tokens are particularly useful for archiving. For example,
to archive all mail older than 30 days by quarter, something like this may
suffice (obviously, the account restriction can be dropped if being used in
a single-purpose configuration file):

	account "archive" disabled maildir "source-maildir"
	action "archive" mbox "%sq%Q"
	match age &gt; 30 days account "archive" action "archive"
	match all account "archive" action "keep"

Then, fdm may be run:

	fdm -vaarchive fetch

To move the mail.

To search mail, similar rules may be used, but all mail should be kept, in this
example by marking the account with 'keep' so that mail is kept no matter what
rules it matches:

	account "search" disabled maildir "source-maildir" keep
	action "found" mbox "search-results"
	match "^From.*Bob" in headers account "search" action "found"
	match all account "search" action "keep"

All mail matching the regexp will be copied to the target mbox. There are
several other ways to write this ruleset and achieve the same end.

<h1>Using fdm behind a proxy </h1>
fdm may be used behind a proxy by specifying the proxy URL using the 'proxy'
option. HTTP and SOCKS5 proxies are supported:

	set proxy "http://proxy.server/"

	set proxy "http://proxy.server:port/"

	set proxy "socks5://proxy.server/"

	set proxy "socks5://proxy.server:port/"

	set proxy "socks5://user@proxy.server/"

	set proxy "socks5://user:pass@proxy.server/"

Authentication is not support for HTTP proxies.

<h1>Bug reports and queries </h1>
Bug reports, queries, suggestions and code are best sent by email to:

	nicm@users.sf.net

Bug reports may also be registered on Sourceforge, but they are likely to be
dealt with much faster by email, particularly as it is easier to elicit
further information if it is required.

<h1>Frequently asked questions </h1>
<h2>Why? </h2>
Two main reasons: 

1. I didn't like the existing tools. I'm not going to do my fetchmail rant
   since getmail's Charles Cazabon has done his own in greater detail here:

	http://pyropus.ca/software/getmail/faq.html#faq-about-why
  
   I'll also spare you my procmail rant, but suffice to say the syntax is 
   abysmal. getmail and maildrop I was less unhappy with overall, but I was
   not really comfortable with their configuration file formats. Plus getmail
   always seemed very slow. And there is reason 2...

2. I disliked the fact that as a home user with a relatively simple setup I
   had to have five programs to deal with mail: sendmail, fetchmail, procmail,
   archivemail, mutt; all with different, variously broken configuration file
   syntaxes, and weird quirks. I now have three programs: sendmail, fdm and
   mutt, and fewer weird configurations to learn and potential problems.

<h2>How do I write regexps? </h2>
See the re_format(7) man page. It is online here (for OpenBSD):

	http://www.openbsd.org/cgi-bin/man.cgi?re_format

There are also a number of books and probably websites on the subject.

<h2>Keep doesn't work with gmail! </h2>
This is because gmail is broken, see:

	http://pyropus.ca/software/getmail/faq.html#faq-notabug-gmail-bug

Gmail also consistently gives false sizes when asked using the POP3 LIST
command, which fdm will warn about.

<h2>Why doesn't fdm run as a daemon? </h2>
Because that is what cron is for: it comes as standard with all sensible
operating systems, and by using it I avoid a lot of code to deal with signals,
configuration reload, extra configuration options and general other crap
related to running all the time. Daemonising is for servers, for stuff that
needs to run periodically, use cron.

<h2>Why does fdm fork child processes when not running as root? </h2>
Because one design is much cleaner and easier to work with than two. And it
has a negligible practical effect on performance in any case.

<h2>Can fdm get rid of that crap in []s added to subjects on some mailing lists? </h2>
Yes! Rewrite the mail using sed to remove the crap, for example:

action "full-disclosure" maildir "%h/mail/full-disclosure"
action "strip-full-disclosure"
	rewrite "sed 's/^\\(Subject:.*\\)\\[Full-disclosure\\] /\\1/'"

match "^List-Id:.*&lt;full-disclosure\\.lists\\.grok\\.org\\.uk&gt;" in headers
	actions { "strip-full-disclosure" "full-disclosure" }

================================================================================
$Id$

</pre>
<hr>
<PRE>
FDM(1)                     OpenBSD Reference Manual                     FDM(1)

<B>NAME</B>
     <B>fdm </B>- fetch and deliver mail

<B>SYNOPSIS</B>
     <B>fdm </B>[<B>-klmnv</B>] [<B>-f </B><I>conffile</I>] [<B>-u </B><I>user</I>] [<B>-a </B><I>account</I>] [<B>-x </B><I>account</I>] [<I>fetch </I>|
         <I>poll</I>]

<B>DESCRIPTION</B>
     The <B>fdm </B>program fetches mail from a POP3 or IMAP server or from <I>stdin </I>and
     delivers it based on a ruleset in the configuration file.

     The options are as follows:

     <B>-a </B><I>name         </I>Process only the specified account. This option may ap-
                     pear multiple times. The account name may include shell
                     glob characters to match multiple accounts.

     <B>-f </B><I>conffile     </I>Specify the configuration file location. Default is
                     <I>~/fdm.conf</I>, or <I>/etc/fdm.conf </I>if that doesn't exist.

     <B>-k              </B>Keep all mail after delivery, regardless of whether it
                     matches a <B>drop </B>action. Note that mails kept in this way
                     will be refetched by <B>fdm </B>if it is run again on the same
                     account.

     <B>-l              </B>Log using syslog(3) rather than to <I>stderr</I>.

     <B>-m              </B>Ignore the lock file and run regardless of other in-
                     stances of <B>fdm</B>.

     <B>-n              </B>Do not process any accounts, just verify the configura-
                     tion file syntax and exit.

     <B>-u </B><I>user         </I>Specify the default user for delivery. This overrides the
                     <B>default-user </B>option in the configuration file.

     <B>-v              </B>Request verbose logging. This option may be specified
                     multiple times.  <B>-vv </B>will print information on configura-
                     tion (useful with <B>-n</B>).  <B>-vvvv </B>duplicates all traffic to
                     and from remote servers to <I>stdout</I>, but note that this
                     feature is disabled when using the <B>-l </B>flag.

     <B>-x </B><I>name         </I>Exclude the named account. Multiple <B>-x </B>options may be
                     specified. As with <B>-a</B>, shell glob characters may be used.

     <I>fetch </I>| <I>poll    </I>The <I>fetch </I>command instructs <B>fdm </B>to fetch and deliver mes-
                     sages. The <I>poll </I>command polls the accounts in the config-
                     uration file and reports a message count for each.

<B>FILES</B>
     ~/.fdm.conf          default <B>fdm </B>configuration file
     /etc/fdm.conf        default system-wide configuration file
     ~/.fdm.lock          default lock file
     /var/db/fdm.lock     lock file for root user

<B>SEE ALSO</B>
     mail(1), fdm.conf(5), sendmail(8)

<B>AUTHORS</B>
     Nicholas Marriott &lt;nicm@users.sourceforge.net&gt;

OpenBSD 4.0                     August 14, 2006                              1
</PRE>
<hr>
<PRE>
FDM.CONF(5)               OpenBSD Programmer's Manual              FDM.CONF(5)

<B>NAME</B>
     <B>fdm.conf </B>- fdm configuration file

<B>DESCRIPTION</B>
     This manual page describes the fdm(1) configuration file.  It defines
     <I>accounts </I>from which to fetch mail, a number of possible <I>actions </I>to take,
     and <I>rules </I>connecting a regexp with an action.  The file is parsed once
     from top to bottom, so action and account definitions must appear before
     they are referenced in a rule.  Rules are evaluated from first to last
     and (unless overridden by the <B>continue </B>keyword) evaluation stops at the
     first match.

     The file has the following format:

     Empty lines and lines beginning with the `#' character are ignored.

     Regexps and strings must be enclosed in double quotes.  Special charac-
     ters in regexps and strings (including passwords) must be escaped.  Note
     that this may mean double-escaping in regexps.

     Possible commands are covered in the following sections.

<B>OPTIONS</B>
     Options are configured using the <B>set </B>command.  It may be followed by the
     following options, one per command:

     <B>maximum-size </B><I>size</I>
             This is used to set the maximum size of a mail.  Mails larger
             than this limit are dropped and, if applicable, not deleted from
             the server.

             The size may be specified as a plain number in bytes or with a
             suffix of `K' for kilobytes, `M' for megabytes or `G' for giga-
             bytes.  The default is one gigabyte.

     <B>delete-oversized</B>
             If this option is specified, fdm(1) attempts to delete messages
             which exceed <B>maximum-size</B>, and continue.  If it is not specified,
             oversize messages are a fatal error and cause fdm(1) to abort.

     <B>allow-multiple</B>
             If this option is specified, fdm(1) does not attempt to create a
             lock file and allows multiple instances to run simultaneously.

     <B>lock-file </B><I>path</I>
             This sets an alternative lock file. The default is <I>~/.fdm.lock</I>
             for non-root users and <I>/var/db/fdm.lock </I>for root.

     <B>default-user </B><I>user</I>
             This sets the default user to change to before delivering mail,
             if fdm(1) is running as root and no alternative user is specified
             as part of the action or rule.  This option may be overridden
             with the <B>-u </B>switch on the command line.  A default user must be
             given if running as root.

     <B>lock-types </B><I>type ...</I>
             This specifies the locks to be used for mbox locking.  Possible
             types are <I>fcntl</I>, <I>flock</I>, and <I>dotlock</I>.  The <I>flock </I>and <I>fcntl </I>types
             are mutually exclusive.  The default is <I>flock</I>.

     <B>domain </B><I>domain </I>| <B>domains </B>{ <I>domain ... </I>}
             This specifies the domains to be used when looking for users with
             the <B>from-headers </B>keyword.  The default is the computer's host-
             name.

     <B>header </B><I>header </I>| <B>headers </B>{ <I>header ... </I>}
             This allows the headers to be examined when looking for users to
             be set.  The default is to look only at the "From" and "Cc" head-
             ers.  The headers are case-insensitive.

     <B>proxy </B><I>url</I>
             This instructs fdm(1) to proxy all connections through <I>url</I>.  HTTP
             and SOCKS5 proxies are supported at present (URLs of the form
             <I>http://host[:port] or socks://[user:pass@]host[:port])</I>.  No au-
             thentication is supported for HTTP.

     <B>unmatched-mail </B><I>drop </I>| <I>keep</I>
             This option controls what fdm(1) does with mail that reaches the
             end of the ruleset (mail that matches no rules or matches only
             rules with the <B>continue </B>keyword).  <I>drop </I>will cause such mail to
             be discarded, and <I>keep </I>will attempt to leave the mail on the
             server.  The default is to keep the mail and log a warning that
             it reached the end of the ruleset.

<B>INCLUDING FILES</B>
     Further configuration files may be including using the <B>include </B>command:

     <B>include </B><I>path</I>

     The file to include is searched for first as an absolute path and then
     relative to the directory containing the main configuration file.

<B>MACROS</B>
     Macros may be defined using the following syntax:

     <I>$name <B></I>= </B><I>string</I>

     <I>%name <B></I>= </B><I>number</I>

     Macros are prefixed with $ to indicate a string value and % to indicate a
     numeric value.  Once defined, a macro may be used in any place a string
     or number is expected. Macros may be embedded in strings by surrounding
     their name (after the $ or %) with {}s, like so:

           "abc ${mymacro} %{anothermacro} def"

<B>ACCOUNTS</B>
     The <B>account </B>command is used to instruct fdm(1) to fetch mail from an ac-
     count.  The syntax is:

     <B>account </B><I>name </I>[<B>disabled</B>] <I>type </I>[<I>args</I>] [<B>keep</B>]

     The <I>name </I>argument is a string specifying a name for the account.  The
     <B>disabled </B>keyword instructs fdm(1) to ignore this account unless it is ex-
     plicitly enabled with a <B>-a </B>option on the command line.  If the <B>keep </B>key-
     word is specified, all mail collected from this account is kept (not
     deleted) even if it matches a <B>drop </B>action.

     Supported account types and arguments are:

     <B>stdin   </B>This account type reads mail from <I>stdin</I>, if it is connected to a
             pipe.  This may be used to deliver mail from sendmail(8), see
             fdm(1) for details.

     <B>pop3 server </B><I>host </I>[<B>port </B><I>port</I>] <B>user </B><I>user <B></I>pass </B><I>pass</I>

     <B>pop3s server </B><I>host </I>[<B>port </B><I>port</I>] <B>user </B><I>user <B></I>pass </B><I>pass</I>
             These statements define a POP3 or POP3S account.  The <I>host</I>, <I>user</I>
             and <I>pass </I>arguments must be strings.  The port option may be ei-
             ther a string which will be looked up in the services(5)
             database, or a number.  If it is omitted, the default port (143
             for POP3, 993 for POP3S) is used.

     <B>imap server </B><I>host </I>[<B>port </B><I>port</I>] <B>user </B><I>user <B></I>pass </B><I>pass </I>[<B>folder </B><I>name</I>]

     <B>imaps server </B><I>host </I>[<B>port </B><I>port</I>] <B>user </B><I>user <B></I>pass </B><I>pass </I>[<B>folder </B><I>name</I>]
             These define an IMAP or IMAPS account.  The parameters are as for
             a POP3 or POP3 account, aside from the additional <B>folder </B>option
             which allows the folder name to be specified (the default is to
             fetch from the inbox).

     <B>maildir </B><I>path</I>

     <B>maildirs </B>{ <I>path ... </I>}
             These account types instruct fdm(1) to fetch mail from the
             maildir or maildirs specified.  This allows fdm(1) to be used to
             filter mail, fetching from a maildir and deleting (dropping) un-
             wanted mail, or delivering mail to another maildir or to an mbox.

<B>ACTIONS</B>
     The <B>action </B>command is used to define actions.  These may be specified by
     name in rules (see below) to perform some action on a mail.  The syntax
     is:

     <B>action </B><I>name </I>[<I>users</I>] <I>action</I>

     The <I>name </I>is a string defining a name for the action.  The optional <I>users</I>
     argument has the following form:

     <B>user </B><I>user </I>| <B>users </B>{ <I>user ... </I>} | <B>user from-headers</B>

     The first two options specify a user or list of users as which the mail
     should be delivered.  If <B>user from-headers </B>is specified, fdm(1) attempts
     to find the users from the mail headers, using the values of the <B>headers</B>
     and <B>domains </B>options.  If no headers are specified, or fdm(1) fails to
     find any valid users in the headers, the default user (set with <B>set</B>
     <B>default-user</B>) is used.  An action's user setting may be overridden in the
     matching rule.  This keyword has no effect if fdm(1) is run as non-root.

     The possible values for <I>action </I>are listed below.  In actions for which a
     <I>command </I>or <I>path </I>is specified, the following substitutions are made before
     it is used: <I>%a </I>is replaced by the account name, <I>%h </I>by the current user's
     home directory, <I>%t </I>by the name of the current action, <I>%u </I>by the current
     user's login name, <I>%n </I>by the UID and <I>%H </I>by the current hour (00-23), <I>%M</I>
     minute (00-59), <I>%S </I>second (00-59), <I>%d </I>day of the month (00-31), <I>%m </I>month
     (01-12), <I>%y </I>year, <I>%W </I>day of the week (0-6, Sunday is 0), <I>%Y </I>day of the
     year (000-365) and <I>%Q </I>quarter (1-4).  In addition, <I>%s </I>is replaced by a
     string specific to the type of account.  When fetching from a maildir,
     this is the basename of the maildir path.  With pop3 or imap, it is the
     hostname of the server, as specified in the account definition.

     <B>drop    </B>Discard the mail.

     <B>keep    </B>Keep the mail, do not remove it from the account.

     <B>maildir </B><I>path</I>
             Save the mail to the maildir specified by <I>path</I>.

     <B>mbox </B><I>path</I>
             Append the mail to the mbox at <I>path</I>.

     <B>pipe </B><I>command</I>
             Pipe the entire mail to <I>command</I>.

     <B>write </B><I>path</I>
             Write the mail to <I>path</I>.

     <B>append </B><I>path</I>
             Append the mail to <I>path</I>.

     <B>smtp server </B><I>host </I>[<B>port </B><I>port</I>] [<B>to </B><I>to</I>]
             Connect to an SMTP server and attempt to deliver the mail to it.
             If <I>to </I>is specified, it is passed to the server in the RCPT TO
             command.  If not, the current user and host names are used.

     <B>rewrite </B><I>command</I>
             Pipe the entire mail through <I>command </I>to generate a new mail and
             use that mail for any following actions or rules.  An example of
             the <B>rewrite </B>action is:

                   action "cat" pipe "cat"
                   action "rewrite" rewrite "sed 's/bob/fred/g'"
                   # this rule will rewrite the message
                   match all action "rewrite" continue
                   # this rule will cat the rewritten message
                   match all action "cat"

<B>RULES</B>
     Rules are specified using the <B>match </B>keyword.  It has one of the following
     basic forms:

     <B>match </B><I>condition </I>[<B>and </B>| <B>or </B><I>condition ...</I>] [<I>accounts</I>] [<I>users</I>] <I>actions</I>
             [<B>continue</B>]

     <B>match </B><I>condition </I>[<B>and </B>| <B>or </B><I>condition ...</I>] [<I>accounts</I>] <B>tag </B><I>string</I>

     The <I>condition </I>argument may be one of:

     <B>all     </B>Matches all mail.

     [<B>not</B>] <B>matched</B>
             Matches only mail that has matched a previous rule and been
             passed on with <B>continue</B>.

     [<B>not</B>] <B>unmatched</B>
             The opposite of <B>matched</B>: matches only mails which have matched no
             previous rules.

     [<B>not</B>] <B>tagged </B><I>string</I>
             Matches mails tagged with <I>string</I>.

     [<B>not</B>] [<B>case</B>] <I>regexp </I>[<B>in headers </B>| <B>in body</B>]
             Specifies a list of regexps against which each mail should be
             matched.  The regexp matches may be restricted to either the
             headers or body of the message by specifying either <B>in headers </B>or
             <B>in body</B>.  The <B>case </B>keyword forces the regexp to be matched case-
             sensitively: the default is case-insensitive matching.

     [<B>not</B>] <B>exec </B><I>command </I>[<B>user </B><I>user</I>] <B>returns </B>(<I>return code</I>, <I>stdout regexp</I>)

     [<B>not</B>] <B>pipe </B><I>command </I>[<B>user </B><I>user</I>] <B>returns </B>(<I>return code</I>, <I>stdout regexp</I>)
             These two conditions execute a <I>command </I>and test its return value
             and output. The <I>return code </I>argument is the numeric return code
             expected and <I>stdout regexp </I>is a regexp to be tested against the
             output of the command to <I>stdout</I>.  Either of these two arguments
             may be omitted: if both are specified, both must match for the
             condition to be true.  The <B>pipe </B>version will pipe the mail to the
             command's <I>stdin </I>when executing it.  If a user is specified,
             fdm(1) will change to that user before executing the command,
             otherwise the current user (or root if started as root) is used.

     [<B>not</B>] <B>size </B>&lt; <I>number</I>

     [<B>not</B>] <B>size </B>&gt; <I>number</I>
             Compare the mail size with <I>number</I>.

     [<B>not</B>] <B>string </B><I>string <B></I>to </B><I>regexp</I>
             Match <I>string </I>against <I>regexp</I>.  If any of %0 to %9 appear in the
             string, they will be replaced with the contents of any subexpres-
             sions from the regexp executed as part of the last <B>regexp </B>condi-
             tion. If no <B>regexp </B>condition has yet been seen, or the mail con-
             tents has been modified by a <B>rewrite </B>action since the last one,
             this condition will log a warning and evaluate to false.

     [<B>not</B>] <B>age </B>&lt; <I>time</I>

     [<B>not</B>] <B>age </B>&gt; <I>time</I>
             The <B>age </B>condition examines the mail's date header to determine
             its age, and matches if the mail is older (&lt;) or newer (&gt;) than
             the time specified.  The time may be given as a simple number in
             seconds, or followed by the word <I>seconds</I>, <I>hours</I>, <I>minutes</I>, <I>days</I>,
             <I>months </I>or <I>years </I>to specify a time in different units.

     Aside from the <B>all </B>condition, multiple conditions may be chained together
     using the <B>and </B>or <B>or </B>keywords.  The conditions are tested from left to
     right.  The <B>not </B>keyword may be specified to invert the sense of a condi-
     tion.

     The first form of the command specifies a number of actions to take when
     a mail matches the rule.  The second form tags the mail with <I>string</I>,
     which may be matched using the <B>tagged </B>condition in later rules. A mail
     may be tagged with any number of different strings by different rules.
     Rules which apply a tag do not count as a match for the purposes of the
     <B>matched </B>or <B>unmatched </B>conditions.

     The optional <I>users </I>argument to the first form has the same syntax as for
     an <B>action </B>definition.  A rule's user list overrides any users given as
     part of the actions.

     Both the <I>accounts </I>and <I>actions </I>parts consist either of a single name or a
     list of names enclosed in braces:

     <B>account </B><I>name </I>| <B>accounts </B>{ <I>name ... </I>}

     <B>action </B><I>name </I>| <B>actions </B>{ <I>name ... </I>}

     The <I>accounts </I>list is used to limit rules to matching mail within a set of
     accounts, and the <I>actions </I>list specifies the actions to perform when the
     rule matches a mail.  The account names may include shell glob wildcards
     to match multiple accounts, as with the <B>-a </B>and <B>-x </B>command line options.
     The actions are performed from left to right in the order they are speci-
     fied in the rule definition.

     If the <B>continue </B>keyword is present, evaluation will not stop if this rule
     is matched.  Instead, fdm(1) will continue to match further rules after
     performing any actions for this rule.

<B>NESTED RULES</B>
     Rules may be nested by specifying further rules in braces:

     <B>match </B><I>condition </I>[<B>and </B>| <B>or </B><I>condition ...</I>] {

     <B>match </B><I>...</I>

     }

     The inner rules will not be evaluated unless the outer one matches. Rules
     may be multiply nested. Note that the outer rule does not count as a
     match for the purposes of the <B>matched </B>and <B>unmatched </B>conditions.

<B>FILES</B>
     ~/.fdm.conf          default <B>fdm.conf </B>configuration file
     /etc/fdm.conf        default system-wide configuration file
     ~/.fdm.lock          default lock file
     /var/db/fdm.lock     lock file for root user

<B>SEE ALSO</B>
     fdm(1), re_format(7)

<B>AUTHORS</B>
     Nicholas Marriott &lt;nicm@users.sourceforge.net&gt;

OpenBSD 4.0                     August 21, 2006                              6
</PRE>
</body>
</html>
